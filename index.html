<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ°´å¾ªç’°å¤§æŒ‘æˆ° Water Cycle Crush</title>
    <style>
        :root {
            --bg-color: #E1F5FE;
            --card-bg: #ffffff;
            --primary-color: #4FC3F7;
            --secondary-color: #F48FB1;
            --text-color: #455A64;
            --grid-gap: 5px;
            --correct-color: #4CAF50;
            --wrong-color: #F44336;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #E1F5FE 0%, #FCE4EC 100%);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: var(--text-color);
            overflow: hidden;
            touch-action: none;
        }

        #app {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            width: 95vw;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            max-height: 95vh;
            overflow-y: auto;
        }

        header {
            width: 100%;
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .stat-box {
            background: white;
            padding: 8px 15px;
            border-radius: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #90A4AE;
        }

        .stat-value {
            font-size: 1.4rem;
            color: var(--primary-color);
        }

        #game-board {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
            gap: var(--grid-gap);
            width: 100%;
            aspect-ratio: 1 / 1;
            background: rgba(255, 255, 255, 0.5);
            padding: 10px;
            border-radius: 15px;
            box-sizing: border-box;
            touch-action: none;
        }

        .cell {
            background: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: clamp(1.2rem, 5vw, 2rem);
            cursor: pointer;
            user-select: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.2s, background-color 0.2s;
            position: relative;
            z-index: 1;
        }

        .cell:active {
            transform: scale(0.9);
        }

        .cell.selected {
            background-color: var(--primary-color);
            color: white;
            animation: pulse 1s infinite;
        }

        .cell.matched {
            animation: popOut 0.3s forwards;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes popOut {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(0); opacity: 0; }
        }

        /* Modal Styles */
        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 20px;
            width: 85%;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            animation: slideUp 0.3s ease-out;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        /* ç­”é¡Œæ§åˆ¶åˆ— (èªè¨€åˆ‡æ› + ç™¼éŸ³) */
        .quiz-controls {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-bottom: 10px;
        }

        .control-btn {
            background: #f0f0f0;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: background 0.2s;
            color: #555;
        }

        .control-btn:hover {
            background: #e0e0e0;
        }

        .control-btn.active {
            background: var(--primary-color);
            color: white;
        }

        .lang-btn {
            border-radius: 12px;
            width: auto;
            padding: 0 10px;
            font-size: 0.9rem;
            font-weight: bold;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-icon {
            font-size: 3rem;
            margin-bottom: 10px;
            display: block;
        }

        h2 {
            margin: 0 0 10px 0;
            color: var(--secondary-color);
        }

        .question-text {
            font-size: 1.1rem;
            margin-bottom: 20px;
            font-weight: 500;
            line-height: 1.5;
            color: #333;
        }

        .options-grid {
            display: flex;
            flex-direction: column;
            gap: 10px;
            transition: opacity 0.3s;
        }
        
        .options-grid.locked {
            pointer-events: none;
            opacity: 0.7;
        }

        button.option-btn {
            background: #f0f0f0;
            border: 2px solid #e0e0e0;
            padding: 12px;
            border-radius: 12px;
            font-size: 1rem;
            color: #555;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            position: relative;
        }

        button.option-btn:hover:not(:disabled) {
            background: #e3f2fd;
            border-color: var(--primary-color);
        }

        button.option-btn:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        button.option-btn.correct {
            background: #d4edda !important;
            border-color: #28a745 !important;
            color: #155724 !important;
        }

        button.option-btn.wrong {
            background: #f8d7da !important;
            border-color: #dc3545 !important;
            color: #721c24 !important;
            animation: shake 0.4s;
        }

        #player-name-input {
            width: 80%;
            padding: 12px;
            font-size: 1.1rem;
            border: 2px solid #ddd;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            outline: none;
            transition: border-color 0.3s;
        }

        #player-name-input:focus {
            border-color: var(--primary-color);
        }

        #quiz-explanation {
            margin-top: 15px;
            padding: 15px;
            background-color: #E3F2FD;
            border-radius: 10px;
            border-left: 5px solid var(--primary-color);
            text-align: left;
            font-size: 0.95rem;
            display: none;
            animation: fadeIn 0.5s;
        }
        
        #quiz-explanation strong {
            display: block;
            margin-bottom: 5px;
            color: #1565C0;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #skip-hint {
            margin-top: 10px;
            font-size: 0.8rem;
            color: #999;
            display: none;
            animation: pulse-text 1.5s infinite;
            cursor: pointer;
        }
        
        @keyframes pulse-text {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }

        #quiz-feedback {
            margin-top: 10px;
            font-weight: bold;
            font-size: 1.1rem;
            min-height: 1.5em; 
        }
        .feedback-correct { color: var(--correct-color); }
        .feedback-wrong { color: var(--wrong-color); }

        .report-list {
            text-align: left;
            margin-top: 15px;
            background: #f9f9f9;
            padding: 15px;
            border-radius: 10px;
            font-size: 0.9rem;
            max-height: 150px;
            overflow-y: auto;
        }
        .report-list li {
            margin-bottom: 8px;
            color: #555;
            border-bottom: 1px dashed #eee;
            padding-bottom: 4px;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        #start-btn, #restart-btn {
            background: linear-gradient(to right, var(--primary-color), #29B6F6);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 30px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            box-shadow: 0 5px 15px rgba(79, 195, 247, 0.4);
            transition: transform 0.2s;
            width: 100%;
        }

        #start-btn:active, #restart-btn:active {
            transform: scale(0.95);
        }

        .combo-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 2px 2px 0px #FF8F00;
            pointer-events: none;
            z-index: 50;
            animation: floatUp 1s forwards;
            display: none;
        }

        @keyframes floatUp {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            20% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -150%); opacity: 0; }
        }

    </style>
</head>
<body>

    <div id="app">
        <header>
            <div class="stat-box">
                <span class="stat-label">åˆ†æ•¸</span>
                <span class="stat-value" id="score-display">0</span>
            </div>
            <div style="display: flex; flex-direction: column; align-items: center;">
                <span style="font-size: 1.2rem; font-weight: bold; color: var(--secondary-color);">Water Cycle</span>
                <span id="player-name-display" style="font-size: 0.8rem; color: #777;"></span>
            </div>
            <div class="stat-box">
                <span class="stat-label">æ­¥æ•¸</span>
                <span class="stat-value" id="moves-display">20</span>
            </div>
        </header>

        <div id="game-board">
            <!-- Grid generated by JS -->
        </div>

        <div id="combo-display" class="combo-text">COMBO!</div>

        <!-- Start Game Modal -->
        <div id="start-modal" class="modal-overlay active">
            <div class="modal-content">
                <span class="modal-icon">ğŸ‘‹</span>
                <h2>æ­¡è¿ä¾†åˆ°æ°´å¾ªç’°å¤§æŒ‘æˆ°</h2>
                <p>è«‹è¼¸å…¥ä½ çš„åå­—é–‹å§‹éŠæˆ²ï¼š</p>
                <input type="text" id="player-name-input" placeholder="ä¾‹å¦‚ï¼šå°æ˜" maxlength="10">
                <p style="font-size: 0.9rem; color: #777; margin-top: 10px;">ğŸ’¡ æ»‘å‹•ç³–æœä¾†æ¶ˆé™¤ï¼Œç­”å°æ‰èƒ½å¾—åˆ†ï¼<br>âš¡ é€£é–æ¶ˆé™¤ç›´æ¥åŠ åˆ†</p>
                <button id="start-btn">é–‹å§‹éŠæˆ²</button>
            </div>
        </div>

        <!-- Quiz Modal -->
        <div id="quiz-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="quiz-controls">
                    <button class="control-btn" id="tts-btn" title="æœ—è®€é¡Œç›®">ğŸ”Š</button>
                    <button class="control-btn lang-btn" id="lang-btn">ENG</button>
                </div>

                <span class="modal-icon">ğŸ¤”</span>
                <h2 id="quiz-title">è€ƒè€ƒä½ ï¼</h2>
                <p id="quiz-question" class="question-text">é¡Œç›®è¼‰å…¥ä¸­...</p>
                
                <div id="quiz-options" class="options-grid">
                    <!-- Options generated by JS -->
                </div>

                <div id="quiz-feedback"></div>
                
                <!-- ç§‘å­¸è§£èªªå€åŸŸ -->
                <div id="quiz-explanation">
                    <strong id="explanation-title">ğŸ“– ç§‘å­¸å°æ•™å®¤ï¼š</strong>
                    <span id="explanation-text"></span>
                </div>

                <div id="skip-hint">â³ è«‹é–±è®€è§€å¿µ (é»æ“Šä»»æ„è™•è·³é)</div>
            </div>
        </div>

        <!-- Game Over Modal -->
        <div id="game-over-modal" class="modal-overlay">
            <div class="modal-content">
                <span class="modal-icon">ğŸ†</span>
                <h2 id="report-title">éŠæˆ²å ±å‘Š</h2>
                
                <div style="display: flex; justify-content: space-around; width: 100%; margin: 15px 0;">
                    <div>
                        <div style="font-size: 0.8rem; color: #777;">æœ€çµ‚åˆ†æ•¸</div>
                        <div id="final-score" style="color: var(--primary-color); font-size: 2rem; font-weight: bold;">0</div>
                    </div>
                    <div>
                        <div style="font-size: 0.8rem; color: #777;">ç­”é¡Œæº–ç¢ºåº¦</div>
                        <div id="final-accuracy" style="color: var(--secondary-color); font-size: 2rem; font-weight: bold;">-</div>
                    </div>
                </div>

                <div style="text-align: left; width: 100%;">
                    <strong style="color: #555;">ğŸ“ éœ€è¦è¤‡ç¿’çš„è§€å¿µï¼š</strong>
                    <div id="review-list" class="report-list">
                        <!-- Wrong answers list -->
                        <div style="text-align: center; color: #999;">å¤ªæ£’äº†ï¼é€™æ¬¡æ²’æœ‰ç­”éŒ¯çš„é¡Œç›®ã€‚</div>
                    </div>
                </div>

                <button id="restart-btn">å†ç©ä¸€æ¬¡</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. éŠæˆ²è³‡æ–™ (é›™èªé¡Œç›®åº«) ---
        // zh: ä¸­æ–‡, en: è‹±æ–‡
        const questions = [
            {
                zh: {
                    question: "å¤©æ°£ç‚ç†±çš„æ™‚å€™ï¼Œæ°´æœƒæ€éº¼æ¨£ï¼Ÿ",
                    answer: "è®Šæˆæ°´è’¸æ°£ï¼ˆè’¸ç™¼ï¼‰",
                    options: ["è®Šæˆæ°´è’¸æ°£ï¼ˆè’¸ç™¼ï¼‰", "è®Šæˆå†°å¡Š", "è®Šæˆæ³¥åœŸ"],
                    explanation: "ç†±èƒ½æœƒè®“æ°´åˆ†å­é‹å‹•è®Šå¿«ï¼Œæ™è„«æ°´çš„æŸç¸›è®Šæˆçœ‹ä¸è¦‹çš„æ°´è’¸æ°£ï¼Œé€™å€‹éç¨‹å«åšè’¸ç™¼ã€‚"
                },
                en: {
                    question: "What happens to water when the weather is hot?",
                    answer: "Turns into water vapor (Evaporation)",
                    options: ["Turns into water vapor (Evaporation)", "Turns into ice", "Turns into soil"],
                    explanation: "Heat energy makes water molecules move faster and escape as invisible water vapor. This process is called evaporation."
                }
            },
            {
                zh: {
                    question: "åœ¨é›²ä¸­ï¼Œæ°´æ˜¯æ€éº¼æ¨£çš„ï¼Ÿ",
                    answer: "æ˜¯æ°´è’¸æ°£ï¼ˆå‡çµï¼‰",
                    options: ["æ˜¯æ°´è’¸æ°£ï¼ˆå‡çµï¼‰", "æ˜¯å†°å¡Š", "æ˜¯å–çš„æ°´"],
                    explanation: "ç•¶æ°´è’¸æ°£å‡åˆ°é«˜ç©ºé‡å†·ï¼Œæœƒå‡çµæˆå°æ°´æ»´æˆ–å°å†°æ™¶ï¼Œèšåœ¨ä¸€èµ·å°±è®Šæˆäº†é›²ã€‚"
                },
                en: {
                    question: "What form is water in the clouds?",
                    answer: "Water vapor (Condensation)",
                    options: ["Water vapor (Condensation)", "Ice cubes", "Drinking water"],
                    explanation: "When water vapor rises and cools, it condenses into tiny water droplets or ice crystals, forming clouds."
                }
            },
            {
                zh: {
                    question: "ç•¶é›²é£„åˆ°å¤©ç©ºæ™‚ï¼Œæœƒç™¼ç”Ÿä»€éº¼äº‹ï¼Ÿ",
                    answer: "æ°´æœƒé™è½æˆé›¨ï¼ˆé™æ°´ï¼‰",
                    options: ["æ°´æœƒé™è½æˆé›¨ï¼ˆé™æ°´ï¼‰", "æ°´æœƒè®Šæˆé›ª", "æ°´æœƒæ¶ˆå¤±"],
                    explanation: "ç•¶é›²è£¡çš„å°æ°´æ»´è¶Šèšè¶Šå¤šï¼Œè®Šå¾—å¤ªé‡è€Œç©ºæ°£æ‰˜ä¸ä½æ™‚ï¼Œå°±æœƒæ‰ä¸‹ä¾†å½¢æˆé›¨ï¼Œé€™å«é™æ°´ã€‚"
                },
                en: {
                    question: "What happens when clouds move across the sky?",
                    answer: "Water falls as rain (Precipitation)",
                    options: ["Water falls as rain (Precipitation)", "Water turns into snow", "Water disappears"],
                    explanation: "When water droplets in clouds gather and become too heavy for the air to hold, they fall as rain. This is called precipitation."
                }
            },
            {
                zh: {
                    question: "å¤å¤©çš„æ™‚å€™ï¼Œæ¸¸æ³³æ± çš„æ°´æœƒæ€éº¼æ¨£ï¼Ÿ",
                    answer: "è’¸ç™¼æˆæ°´è’¸æ°£",
                    options: ["è’¸ç™¼æˆæ°´è’¸æ°£", "è®Šæˆå†°", "è®Šæˆé£²æ–™"],
                    explanation: "å¤å¤©å¤ªé™½å¾ˆå¤§ï¼Œç†±èƒ½æœƒåŠ é€Ÿæ°´é¢è’¸ç™¼ï¼Œæ‰€ä»¥æ¸¸æ³³æ± çš„æ°´ä½æœƒæ…¢æ…¢ä¸‹é™ã€‚"
                },
                en: {
                    question: "What happens to pool water in the summer?",
                    answer: "Evaporates into water vapor",
                    options: ["Evaporates into water vapor", "Turns into ice", "Turns into a drink"],
                    explanation: "The sun's heat speeds up evaporation from the surface, so the water level in the pool slowly drops."
                }
            },
            {
                zh: {
                    question: "é›¨æ°´æ˜¯æ€éº¼ä¾†çš„ï¼Ÿ",
                    answer: "å¾é›²è£¡é™è½ï¼ˆé™æ°´ï¼‰",
                    options: ["å¾é›²è£¡é™è½ï¼ˆé™æ°´ï¼‰", "ç›´æ¥å¾åœ°é¢", "å¾æ¨¹ä¸Šæ‰ä¸‹ä¾†"],
                    explanation: "é›¨æ°´æ˜¯é›²å±¤ä¸­çš„æ°´æ»´è®Šå¤§å¾Œï¼Œå—é‡åŠ›å½±éŸ¿æ‰è½ä¸‹ä¾†çš„ç¾è±¡ã€‚"
                },
                en: {
                    question: "Where does rain come from?",
                    answer: "Falls from clouds (Precipitation)",
                    options: ["Falls from clouds (Precipitation)", "Directly from the ground", "Falls from trees"],
                    explanation: "Rain occurs when water droplets in clouds grow larger and fall due to gravity."
                }
            },
            {
                zh: {
                    question: "æ—©æ™¨ç‚ºä»€éº¼æœ‰éœ§ï¼Ÿ",
                    answer: "æ°´è’¸æ°£å‡çµæˆå°æ°´æ»´",
                    options: ["æ°´è’¸æ°£å‡çµæˆå°æ°´æ»´", "æ°´è’¸æ°£æ¶ˆå¤±", "é›²è®Šæˆéœ§"],
                    explanation: "å¤œæ™šåœ°é¢è®Šå†·ï¼Œæ¥è¿‘åœ°é¢çš„æ°´è’¸æ°£é‡å†·å‡çµæˆæ‡¸æµ®çš„å°æ°´æ»´ï¼Œå°±å½¢æˆäº†éœ§ã€‚"
                },
                en: {
                    question: "Why is there fog in the morning?",
                    answer: "Water vapor condenses into droplets",
                    options: ["Water vapor condenses into droplets", "Water vapor disappears", "Clouds turn into fog"],
                    explanation: "The ground cools at night, causing water vapor near the ground to condense into tiny floating droplets, forming fog."
                }
            },
            {
                zh: {
                    question: "èŠ±åœ’è£¡çš„æ°´ï¼Œç•¶å¤ªé™½å‡ºä¾†çš„æ™‚å€™æœƒç™¼ç”Ÿä»€éº¼ï¼Ÿ",
                    answer: "è’¸ç™¼ï¼ˆè’¸ç™¼ï¼‰",
                    options: ["è’¸ç™¼ï¼ˆè’¸ç™¼ï¼‰", "è®Šæˆæ³¥åœŸ", "è®Šæˆå†°"],
                    explanation: "å¤ªé™½çš„ç†±åŠ›æœƒè®“åœŸå£¤æˆ–è‘‰å­ä¸Šçš„æ°´åˆ†è½‰è®Šæˆæ°£é«”ï¼Œå›åˆ°ç©ºæ°£ä¸­ã€‚"
                },
                en: {
                    question: "What happens to garden water when the sun comes out?",
                    answer: "Evaporates (Evaporation)",
                    options: ["Evaporates (Evaporation)", "Turns into soil", "Turns into ice"],
                    explanation: "The sun's heat turns water on soil or leaves into gas, returning it to the air."
                }
            },
            {
                zh: {
                    question: "å†¬å¤©ä¸‹é›ªçš„æ™‚å€™ï¼Œæ°´æ˜¯æ€éº¼åœ¨å¤©ä¸Šå½¢æˆçš„ï¼Ÿ",
                    answer: "è³ªè®Šæˆé›²ï¼ˆå‡çµï¼‰",
                    options: ["è³ªè®Šæˆé›²ï¼ˆå‡çµï¼‰", "è®Šæˆé›¨", "è®Šæˆæ°´æ»´"],
                    explanation: "åœ¨éå¸¸å†·çš„é«˜ç©ºï¼Œæ°´è’¸æ°£æœƒç›´æ¥å‡è¯æˆå°å†°æ™¶ï¼Œèšé›†å¾Œæ‰è½å°±æ˜¯é›ªã€‚"
                },
                en: {
                    question: "How does snow form in the sky in winter?",
                    answer: "Turns into clouds (Condensation)",
                    options: ["Turns into clouds (Condensation)", "Turns into rain", "Turns into droplets"],
                    explanation: "In very cold air, water vapor turns directly into ice crystals. When they gather and fall, it is snow."
                }
            },
            {
                zh: {
                    question: "é›¨å¾Œå¤©ç©ºä¸­æœ‰å½©è™¹ï¼Œé€™æ˜¯å› ç‚ºä»€éº¼ï¼Ÿ",
                    answer: "æ°´è’¸æ°£åœ¨ç©ºä¸­å‡çµ",
                    options: ["æ°´è’¸æ°£åœ¨ç©ºä¸­å‡çµ", "é›²å‡ºç¾äº†", "æ°´è®Šæˆå†°"],
                    explanation: "å½©è™¹æ˜¯å› ç‚ºé™½å…‰ç…§å°„åˆ°ç©ºæ°£ä¸­æ®˜ç•™çš„å°æ°´æ»´ï¼Œç”¢ç”ŸæŠ˜å°„å’Œåå°„å½¢æˆçš„ã€‚"
                },
                en: {
                    question: "Why is there a rainbow after rain?",
                    answer: "Water vapor condenses in the air",
                    options: ["Water vapor condenses in the air", "Clouds appear", "Water turns into ice"],
                    explanation: "Rainbows form when sunlight hits remaining water droplets in the air, creating refraction and reflection."
                }
            },
            {
                zh: {
                    question: "æ¤ç‰©æ€éº¼å¾—åˆ°æ°´ï¼Ÿ",
                    answer: "å¾åœŸå£¤è£¡å¸æ”¶æ°´ï¼ˆé™æ°´ï¼‰",
                    options: ["å¾åœŸå£¤è£¡å¸æ”¶æ°´ï¼ˆé™æ°´ï¼‰", "å¾å¤ªé™½é‚£è£¡", "å¾é¢¨ä¸­"],
                    explanation: "é›¨æ°´ï¼ˆé™æ°´ï¼‰æ»²å…¥åœŸå£¤å¾Œï¼Œæ¤ç‰©çš„æ ¹éƒ¨æœƒæŠŠæ°´å¸ä¸Šä¾†ç¶­æŒç”Ÿå‘½ã€‚"
                },
                en: {
                    question: "How do plants get water?",
                    answer: "Absorb from soil (Precipitation)",
                    options: ["Absorb from soil (Precipitation)", "From the sun", "From the wind"],
                    explanation: "After rain (precipitation) soaks into the soil, plant roots absorb the water to survive."
                }
            },
            {
                zh: {
                    question: "ç†±æ°´å£ºè£¡çš„æ°´åŠ ç†±å¾Œæœƒæ€éº¼æ¨£ï¼Ÿ",
                    answer: "è®Šæˆæ°´è’¸æ°£ï¼ˆè’¸ç™¼ï¼‰",
                    options: ["è®Šæˆæ°´è’¸æ°£ï¼ˆè’¸ç™¼ï¼‰", "è®Šæˆå†°å¡Š", "è®Šæˆé£²æ–™"],
                    explanation: "åŠ ç†±æä¾›äº†èƒ½é‡ï¼Œè®“æ°´å¿«é€Ÿæ²¸é¨°ä¸¦å¤§é‡è½‰è®Šç‚ºæ°´è’¸æ°£ã€‚"
                },
                en: {
                    question: "What happens when water in a kettle is heated?",
                    answer: "Turns into water vapor (Evaporation)",
                    options: ["Turns into water vapor (Evaporation)", "Turns into ice", "Turns into a drink"],
                    explanation: "Heating provides energy, causing water to boil quickly and turn into water vapor."
                }
            },
            {
                zh: {
                    question: "æ™šä¸Šï¼Œå¦‚æœç©ºæ°£è£¡çš„æ°´è’¸æ°£è®Šå†·äº†æœƒæ€éº¼æ¨£ï¼Ÿ",
                    answer: "å½¢æˆéœ²ç ï¼ˆå‡çµï¼‰",
                    options: ["å½¢æˆéœ²ç ï¼ˆå‡çµï¼‰", "è®Šæˆå¤ªé™½", "æ¶ˆå¤±"],
                    explanation: "æ™šä¸Šçš„å†·ç©ºæ°£è®“æ°´è’¸æ°£æ¥è§¸åˆ°å†°æ¶¼çš„è‰è‘‰è¡¨é¢æ™‚ï¼Œå‡çµæˆæ¶²æ…‹çš„å°æ°´ç ï¼Œç¨±ç‚ºéœ²æ°´ã€‚"
                },
                en: {
                    question: "What happens if water vapor in the air cools at night?",
                    answer: "Forms dew (Condensation)",
                    options: ["Forms dew (Condensation)", "Turns into the sun", "Disappears"],
                    explanation: "Cool air at night causes water vapor to condense into liquid droplets on cool surfaces like grass, forming dew."
                }
            },
            {
                zh: {
                    question: "ä¸‹é›¨çš„æ™‚å€™ï¼Œæ°´å»å“ªè£¡äº†ï¼Ÿ",
                    answer: "å¾é›²è£¡æ‰ä¸‹ä¾†ï¼ˆé™æ°´ï¼‰",
                    options: ["å¾é›²è£¡æ‰ä¸‹ä¾†ï¼ˆé™æ°´ï¼‰", "æ¶ˆå¤±äº†", "å›åˆ°åœŸè£¡"],
                    explanation: "é›¨æ°´æœƒè½åˆ°åœ°é¢ï¼Œæœ‰çš„æµå…¥æ²³æµï¼Œæœ‰çš„æ»²å…¥åœ°ä¸‹ï¼Œæœ€å¾Œå†æµå›å¤§æµ·ï¼Œå®Œæˆå¾ªç’°ã€‚"
                },
                en: {
                    question: "Where does water go when it rains?",
                    answer: "Falls from clouds (Precipitation)",
                    options: ["Falls from clouds (Precipitation)", "Disappears", "Returns to the soil"],
                    explanation: "Rain falls to the ground, flows into rivers, soaks into the ground, and eventually returns to the ocean, completing the cycle."
                }
            },
            {
                zh: {
                    question: "åœ¨å¤å¤©ç‚ç†±çš„åŸå¸‚è£¡ï¼Œé¦¬è·¯ä¸Šçš„æ°´æœƒæ€éº¼æ¨£ï¼Ÿ",
                    answer: "æ¸æ¸è’¸ç™¼ï¼ˆè’¸ç™¼ï¼‰",
                    options: ["æ¸æ¸è’¸ç™¼ï¼ˆè’¸ç™¼ï¼‰", "è®Šæˆå†°", "ç”Ÿæˆæ³¥å¡µ"],
                    explanation: "æŸæ²¹è·¯å¸ç†±å¿«ï¼Œé«˜æº«æœƒè®“ç‘åœ¨è·¯ä¸Šçš„æ°´éå¸¸è¿…é€Ÿåœ°è’¸ç™¼æ‰ã€‚"
                },
                en: {
                    question: "What happens to water on the road in a hot city?",
                    answer: "Gradually evaporates (Evaporation)",
                    options: ["Gradually evaporates (Evaporation)", "Turns into ice", "Creates dust"],
                    explanation: "Asphalt absorbs heat quickly, and the high temperature causes water on the road to evaporate very fast."
                }
            },
            {
                zh: {
                    question: "æ°´è’¸æ°£åœ¨ç©ºä¸­æœƒæ€éº¼å½¢æˆé›²ï¼Ÿ",
                    answer: "å› ç‚ºè®Šå†·å‡çµ",
                    options: ["å› ç‚ºè®Šå†·å‡çµ", "å› ç‚ºè®Šç†±", "å› ç‚ºä¸‹é›¨"],
                    explanation: "é«˜ç©ºæº«åº¦æ¯”åœ°é¢ä½ï¼Œç†±ç©ºæ°£ä¸Šå‡å¾Œè®Šå†·ï¼Œæ°´è’¸æ°£å°±æœƒå‡çµæˆé›²ã€‚"
                },
                en: {
                    question: "How does water vapor form clouds in the air?",
                    answer: "By cooling and condensing",
                    options: ["By cooling and condensing", "By getting hot", "Because of rain"],
                    explanation: "The air is cooler high up. As warm air rises and cools, water vapor condenses to form clouds."
                }
            },
            {
                zh: {
                    question: "æˆ‘å€‘å¾å“ªè£¡èƒ½æ‰¾åˆ°é›²ä¸­çš„æ°´ï¼Ÿ",
                    answer: "æ°´è’¸æ°£å‡çµ",
                    options: ["æ°´è’¸æ°£å‡çµ", "æ²³è£¡", "åœ°é¢"],
                    explanation: "é›–ç„¶é›²åœ¨å¤©ä¸Šï¼Œä½†å®ƒå…¶å¯¦å°±æ˜¯ç”±ç„¡æ•¸çš„å°æ°´æ»´æˆ–å°å†°æ™¶çµ„æˆçš„ã€‚"
                },
                en: {
                    question: "Where can we find the water in clouds?",
                    answer: "Water vapor condensation",
                    options: ["Water vapor condensation", "In rivers", "On the ground"],
                    explanation: "Clouds are actually made up of countless tiny water droplets or ice crystals."
                }
            },
            {
                zh: {
                    question: "ç•¶é›²è®Šåšï¼Œæœƒç™¼ç”Ÿä»€éº¼ï¼Ÿ",
                    answer: "é–‹å§‹ä¸‹é›¨ï¼ˆé™æ°´ï¼‰",
                    options: ["é–‹å§‹ä¸‹é›¨ï¼ˆé™æ°´ï¼‰", "è®Šæˆç™½é›²", "æ¶ˆå¤±"],
                    explanation: "é›²è®Šåšè®Šé»‘ä»£è¡¨æ°´æ»´éå¸¸å¯†é›†ä¸”åšé‡ï¼Œé™½å…‰ç©¿ä¸é€ï¼Œé€šå¸¸é ç¤ºè‘—å¿«è¦ä¸‹é›¨äº†ã€‚"
                },
                en: {
                    question: "What happens when clouds get thick?",
                    answer: "Starts to rain (Precipitation)",
                    options: ["Starts to rain (Precipitation)", "Turns into white clouds", "Disappears"],
                    explanation: "Thick, dark clouds mean water droplets are dense and heavy, blocking sunlight, usually indicating rain is coming."
                }
            },
            {
                zh: {
                    question: "ç•¶æ°´é¢ä¸Šæœ‰æ°´è’¸æ°£æ™‚ï¼Œæˆ‘å€‘åœ¨æ°´è£¡æ‡‰è©²æ³¨æ„ä»€éº¼ï¼Ÿ",
                    answer: "æ°´æœƒè’¸ç™¼ï¼ˆè’¸ç™¼ï¼‰",
                    options: ["æ°´æœƒè’¸ç™¼ï¼ˆè’¸ç™¼ï¼‰", "æ°´æœƒè®Šå¤š", "æ°´æœƒè®Šæˆå†°"],
                    explanation: "æ°´æ™‚åˆ»éƒ½åœ¨è’¸ç™¼ï¼Œåªæ˜¯æº«åº¦è¶Šé«˜è’¸ç™¼è¶Šå¿«ï¼Œæˆ‘å€‘è‚‰çœ¼ä¸ä¸€å®šçœ‹å¾—åˆ°ã€‚"
                },
                en: {
                    question: "What should we note when there is water vapor over water?",
                    answer: "Water is evaporating (Evaporation)",
                    options: ["Water is evaporating (Evaporation)", "Water increases", "Water turns into ice"],
                    explanation: "Water evaporates all the time. Higher temperatures mean faster evaporation, even if we can't always see it."
                }
            },
            {
                zh: {
                    question: "ç§‹å¤©æ™‚ï¼Œç©ºæ°£è®Šæ¶¼ï¼Œæ°´æœƒç™¼ç”Ÿä»€éº¼ï¼Ÿ",
                    answer: "å½¢æˆå°æ°´ç ï¼ˆå‡çµï¼‰",
                    options: ["å½¢æˆå°æ°´ç ï¼ˆå‡çµï¼‰", "æ¶ˆå¤±äº†", "è®Šæˆå†°"],
                    explanation: "æ¶¼çˆ½çš„ç©ºæ°£è®“æ°´è’¸æ°£æ›´å®¹æ˜“å‡çµï¼Œæ‰€ä»¥ç§‹å¤©çš„æ—©æ™¨å¸¸èƒ½åœ¨çª—æˆ¶æˆ–è»Šä¸Šçœ‹åˆ°éœ§æ°£ã€‚"
                },
                en: {
                    question: "What happens to water in autumn when the air gets cool?",
                    answer: "Forms small droplets (Condensation)",
                    options: ["Forms small droplets (Condensation)", "Disappears", "Turns into ice"],
                    explanation: "Cool air makes it easier for water vapor to condense, so we often see mist on windows or cars in autumn mornings."
                }
            },
            {
                zh: {
                    question: "å¤©ä¸Šæœ‰å¾ˆå¤šé›²ï¼Œæœƒç™¼ç”Ÿä»€éº¼ï¼Ÿ",
                    answer: "æœ‰å¯èƒ½æœƒä¸‹é›¨ï¼ˆé™æ°´ï¼‰",
                    options: ["æœ‰å¯èƒ½æœƒä¸‹é›¨ï¼ˆé™æ°´ï¼‰", "ç©ºæ°£è®Šç†±", "é›²è®Šå¾—æ›´ç™½"],
                    explanation: "é›²é‡å¤šä»£è¡¨ç©ºæ°£ä¸­æ°´æ°£å……è¶³ï¼Œä¸‹é›¨çš„æ©Ÿç‡è‡ªç„¶å°±è®Šé«˜äº†ã€‚"
                },
                en: {
                    question: "What happens when there are many clouds in the sky?",
                    answer: "It might rain (Precipitation)",
                    options: ["It might rain (Precipitation)", "Air gets hot", "Clouds get whiter"],
                    explanation: "Many clouds mean there is plenty of moisture in the air, increasing the chance of rain."
                }
            }
        ];

        // --- 2. éŠæˆ²è¨­å®šèˆ‡è®Šæ•¸ ---
        const width = 8;
        const grid = document.querySelector('#game-board');
        const scoreDisplay = document.querySelector('#score-display');
        const movesDisplay = document.querySelector('#moves-display');
        const playerNameDisplay = document.querySelector('#player-name-display');
        const candyColors = ['ğŸ’§', 'â˜€ï¸', 'â˜ï¸', 'â„ï¸', 'ğŸŒˆ', 'â˜”']; 
        
        let squares = [];
        let score = 0;
        let moves = 20;
        let selectedSquare = null;
        let isProcessing = false;
        let playerName = "å­¸ç”Ÿ";
        let holdTimer = null;
        
        // èªè¨€è¨­å®š
        let currentLang = 'zh'; // 'zh' or 'en'
        let currentQData = null; // ç•¶å‰é¡Œç›®è³‡æ–™
        
        // æ‹–æ›³èˆ‡æ»‘å‹•ç›¸é—œè®Šæ•¸
        let squareIdBeingDragged;
        let squareIdBeingReplaced;
        let touchStartX = 0;
        let touchStartY = 0;
        let touchEndX = 0;
        let touchEndY = 0;
        
        // å­¸ç¿’å ±å‘Šæ•¸æ“š
        let wrongQuestionsSet = new Set(); 
        let totalQuestionsAnswered = 0;
        let firstTryCorrectCount = 0;

        // --- 3. åˆå§‹åŒ–éŠæˆ² ---
        function initGame() {
            const nameInput = document.getElementById('player-name-input').value.trim();
            if (nameInput) {
                playerName = nameInput;
            }
            playerNameDisplay.innerText = `ç©å®¶: ${playerName}`;

            grid.innerHTML = '';
            squares = [];
            score = 0;
            moves = 20;
            wrongQuestionsSet.clear();
            totalQuestionsAnswered = 0;
            firstTryCorrectCount = 0;

            updateStats();
            createBoard();
            
            window.setTimeout(() => {
                checkRowForThree(true);
                checkColumnForThree(true);
            }, 100);
        }

        function createBoard() {
            for (let i = 0; i < width * width; i++) {
                const square = document.createElement('div');
                square.setAttribute('draggable', true);
                square.setAttribute('id', i);
                square.classList.add('cell');
                
                let randomColor = Math.floor(Math.random() * candyColors.length);
                square.innerText = candyColors[randomColor];
                square.setAttribute('data-type', candyColors[randomColor]);
                
                grid.appendChild(square);
                squares.push(square);

                // Mouse Events
                square.addEventListener('dragstart', dragStart);
                square.addEventListener('dragend', dragEnd);
                square.addEventListener('dragover', dragOver);
                square.addEventListener('dragenter', dragEnter);
                square.addEventListener('dragleave', dragLeave);
                square.addEventListener('drop', dragDrop);

                // Touch Events
                square.addEventListener('touchstart', touchStart, {passive: false});
                square.addEventListener('touchmove', touchMove, {passive: false});
                square.addEventListener('touchend', touchEnd);

                square.addEventListener('click', () => clickSquare(square));
            }
        }

        // --- 4. äº’å‹•é‚è¼¯ ---
        function dragStart() {
            if (isProcessing || moves <= 0) return;
            squareIdBeingDragged = parseInt(this.id);
        }
        function dragOver(e) { e.preventDefault(); }
        function dragEnter(e) { e.preventDefault(); }
        function dragLeave() {}
        function dragDrop() {
            if (isProcessing || moves <= 0) return;
            squareIdBeingReplaced = parseInt(this.id);
            if(isValidMove(squareIdBeingDragged, squareIdBeingReplaced)) {
                swapSquare(squares[squareIdBeingDragged], squares[squareIdBeingReplaced]);
            }
        }
        function dragEnd() {}

        function touchStart(e) {
            if (isProcessing || moves <= 0) return;
            touchStartX = e.changedTouches[0].screenX;
            touchStartY = e.changedTouches[0].screenY;
        }
        function touchMove(e) {}
        function touchEnd(e) {
            if (isProcessing || moves <= 0) return;
            touchEndX = e.changedTouches[0].screenX;
            touchEndY = e.changedTouches[0].screenY;
            handleSwipe(parseInt(this.id));
        }
        function handleSwipe(startId) {
            const diffX = touchEndX - touchStartX;
            const diffY = touchEndY - touchStartY;
            const threshold = 30;
            let targetId = -1;
            if (Math.abs(diffX) > Math.abs(diffY)) {
                if (Math.abs(diffX) > threshold) {
                    if (diffX > 0) targetId = startId + 1;
                    else targetId = startId - 1;
                    if (diffX > 0 && startId % width === width - 1) return;
                    if (diffX < 0 && startId % width === 0) return;
                }
            } else {
                if (Math.abs(diffY) > threshold) {
                    if (diffY > 0) targetId = startId + width;
                    else targetId = startId - width;
                }
            }
            if (targetId >= 0 && targetId < width * width) {
                swapSquare(squares[startId], squares[targetId]);
            }
        }
        function clickSquare(square) {
            if (isProcessing || moves <= 0) return;
            if (!selectedSquare) {
                selectedSquare = square;
                square.classList.add('selected');
            } else {
                const currentId = parseInt(square.id);
                const prevId = parseInt(selectedSquare.id);
                selectedSquare.classList.remove('selected');
                selectedSquare = null;
                if (currentId === prevId) return;
                if (isValidMove(prevId, currentId)) {
                    swapSquare(squares[prevId], squares[currentId]);
                }
            }
        }
        function isValidMove(id1, id2) {
            const isAdjacent = [id1 - 1, id1 + 1, id1 - width, id1 + width].includes(id2);
            const isRightEdge = (id1 % width === width - 1) && (id2 === id1 + 1);
            const isLeftEdge = (id1 % width === 0) && (id2 === id1 - 1);
            return isAdjacent && !isRightEdge && !isLeftEdge;
        }

        function swapSquare(square1, square2) {
            isProcessing = true;
            const tempType = square1.getAttribute('data-type');
            const tempText = square1.innerText;
            square1.setAttribute('data-type', square2.getAttribute('data-type'));
            square1.innerText = square2.innerText;
            square2.setAttribute('data-type', tempType);
            square2.innerText = tempText;

            const matchFound = checkForMatches(false);
            if (matchFound) {
                setTimeout(() => {
                    presentQuiz(square1, square2); 
                }, 300);
            } else {
                setTimeout(() => {
                    square2.setAttribute('data-type', square1.getAttribute('data-type'));
                    square2.innerText = square1.innerText;
                    square1.setAttribute('data-type', tempType);
                    square1.innerText = tempText;
                    square1.style.animation = 'shake 0.4s';
                    square2.style.animation = 'shake 0.4s';
                    setTimeout(() => {
                        square1.style.animation = '';
                        square2.style.animation = '';
                        isProcessing = false;
                    }, 400);
                }, 300);
            }
        }

        // --- 5. ç­”é¡Œç³»çµ± (é›™èªç‰ˆ) ---
        let currentQuizIndex = -1; // è¿½è¹¤ç•¶å‰é¡Œç›®ç´¢å¼•
        let currentOptionsOrder = []; // è¿½è¹¤ç•¶å‰é¸é …é †åº

        function presentQuiz(square1, square2) {
            // é‡ç½® UI ç‹€æ…‹ (ä¿®å¾©ï¼šç¢ºä¿æ¯æ¬¡æ–°é¡Œç›®éƒ½æ˜¯ä¹¾æ·¨çš„)
            document.getElementById('quiz-feedback').innerText = '';
            document.getElementById('quiz-feedback').className = '';
            document.getElementById('quiz-explanation').style.display = 'none';
            document.getElementById('skip-hint').style.display = 'none';
            document.getElementById('quiz-options').classList.remove('locked');

            // éš¨æ©Ÿé¸é¡Œ
            currentQuizIndex = Math.floor(Math.random() * questions.length);
            
            // é‡ç½®é¸é …é †åºï¼Œéš¨æ©Ÿæ’åˆ—ä¸€æ¬¡
            const rawOptions = questions[currentQuizIndex].zh.options; // é€™è£¡åªç”¨ä¾†ç”¢ç”Ÿç´¢å¼•
            currentOptionsOrder = Array.from({length: rawOptions.length}, (_, i) => i).sort(() => Math.random() - 0.5);

            renderQuizContent(square1, square2);
            
            const modal = document.getElementById('quiz-modal');
            modal.classList.add('active');
            
            // ç¶å®šææ—©è§£é™¤
            modal.onclick = (e) => {
                // å¦‚æœé»åˆ°æ§åˆ¶æŒ‰éˆ•ï¼Œä¸è§¸ç™¼è§£é™¤
                if (e.target.closest('.control-btn')) return;

                if (holdTimer) {
                    clearTimeout(holdTimer);
                    holdTimer = null;
                    const optsEl = document.getElementById('quiz-options');
                    const feedbackEl = document.getElementById('quiz-feedback');
                    const skipHint = document.getElementById('skip-hint');
                    
                    if (optsEl.querySelectorAll('.correct').length > 0) {
                        modal.classList.remove('active');
                        handleCorrectAnswer();
                    } else {
                        optsEl.classList.remove('locked');
                        const wrongBtns = optsEl.querySelectorAll('.wrong');
                        wrongBtns.forEach(b => b.disabled = true);
                        feedbackEl.innerText = currentLang === 'zh' ? 'ğŸ’ª åŠ æ²¹ï¼Œå†è©¦ä¸€æ¬¡ï¼' : 'ğŸ’ª Try again!';
                        feedbackEl.style.color = '#555';
                        skipHint.style.display = 'none';
                    }
                }
            };
        }

        // æ¸²æŸ“é¡Œç›®å…§å®¹ (åˆ†é›¢å‡ºä¾†ä»¥ä¾¿åˆ‡æ›èªè¨€)
        function renderQuizContent(square1, square2) {
            const qData = questions[currentQuizIndex][currentLang];
            const qTitle = document.getElementById('quiz-title');
            const qEl = document.getElementById('quiz-question');
            const optsEl = document.getElementById('quiz-options');
            const feedbackEl = document.getElementById('quiz-feedback');
            const explSection = document.getElementById('quiz-explanation');
            const explTitle = document.getElementById('explanation-title');
            const explText = document.getElementById('explanation-text');
            const skipHint = document.getElementById('skip-hint');
            const langBtn = document.getElementById('lang-btn');

            // æ›´æ–° UI æ–‡å­—
            langBtn.innerText = currentLang === 'zh' ? 'ENG' : 'ä¸­æ–‡';
            qTitle.innerText = currentLang === 'zh' ? 'è€ƒè€ƒä½ ï¼' : 'Quiz Time!';
            qEl.innerText = qData.question;
            explTitle.innerText = currentLang === 'zh' ? 'ğŸ“– ç§‘å­¸å°æ•™å®¤ï¼š' : 'ğŸ“– Science Fact:';
            explText.innerText = qData.explanation;

            // æ¸…ç©ºèˆŠé¸é …
            optsEl.innerHTML = '';
            
            // ä½¿ç”¨ä¹‹å‰ç”Ÿæˆçš„éš¨æ©Ÿé †åºæ¸²æŸ“é¸é …
            currentOptionsOrder.forEach(idx => {
                const optText = qData.options[idx];
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerText = optText;
                
                // é»æ“Šäº‹ä»¶
                btn.onclick = (e) => {
                    e.stopPropagation();
                    if (btn.classList.contains('wrong') || btn.classList.contains('correct') || optsEl.classList.contains('locked')) return;

                    const correctAnswer = qData.answer; // ç•¶å‰èªè¨€çš„æ­£ç¢ºç­”æ¡ˆ
                    
                    if (optText === correctAnswer) {
                        // --- ç­”å° ---
                        btn.classList.add('correct');
                        feedbackEl.innerText = currentLang === 'zh' ? 'âœ… å¤ªæ£’äº†ï¼ç­”å°äº†ï¼' : 'âœ… Correct! Great job!';
                        feedbackEl.className = 'feedback-correct';
                        
                        totalQuestionsAnswered++;
                        
                        const allBtns = optsEl.querySelectorAll('button');
                        allBtns.forEach(b => b.disabled = true);
                        
                        explSection.style.display = 'block';
                        skipHint.style.display = 'block';
                        skipHint.innerText = currentLang === 'zh' ? 'â³ é–±è®€æ™‚é–“... (é»æ“Šä»»æ„è™•ç¹¼çºŒ)' : 'â³ Reading time... (Click anywhere to skip)';

                        startHoldTimer(3000, () => {
                            const modal = document.getElementById('quiz-modal');
                            modal.classList.remove('active');
                            handleCorrectAnswer();
                        });
                        
                        // æ’­æ”¾æ­£ç¢ºéŸ³æ•ˆæˆ–TTS (å¯é¸)
                        speakText(currentLang === 'zh' ? 'ç­”å°äº†' : 'Correct');

                    } else {
                        // --- ç­”éŒ¯ ---
                        btn.classList.add('wrong');
                        feedbackEl.innerText = currentLang === 'zh' ? 'âŒ ä¸å°å–”ï¼Œå…ˆçœ‹çœ‹åŸç†è§£èªªï¼' : 'âŒ Incorrect. Read the explanation!';
                        feedbackEl.className = 'feedback-wrong';
                        
                        // è¨˜éŒ„ä¸­æ–‡é¡Œç›®ä½œç‚ºéŒ¯é¡Œ (ä¿æŒçµ±ä¸€)
                        const zhQ = questions[currentQuizIndex].zh;
                        wrongQuestionsSet.add(zhQ.question + " (æ­£è§£: " + zhQ.answer + ")");
                        
                        explSection.style.display = 'block';
                        optsEl.classList.add('locked');
                        skipHint.style.display = 'block';
                        skipHint.innerText = currentLang === 'zh' ? 'â³ è«‹é–±è®€è§€å¿µ... (3ç§’å¾Œå¯é‡ç­”)' : 'â³ Please read... (Retry in 3s)';

                        startHoldTimer(3000, () => {
                            optsEl.classList.remove('locked');
                            btn.disabled = true;
                            feedbackEl.innerText = currentLang === 'zh' ? 'ğŸ’ª åŠ æ²¹ï¼Œå†è©¦ä¸€æ¬¡ï¼' : 'ğŸ’ª Try again!';
                            feedbackEl.style.color = '#555';
                            skipHint.style.display = 'none';
                        });
                        
                         // æ’­æ”¾éŒ¯èª¤éŸ³æ•ˆæˆ–TTS (å¯é¸)
                         speakText(currentLang === 'zh' ? 'å†è©¦ä¸€æ¬¡' : 'Try again');
                    }
                };
                optsEl.appendChild(btn);
            });
        }

        // --- èªè¨€åˆ‡æ›èˆ‡ç™¼éŸ³åŠŸèƒ½ ---

        // 1. åˆ‡æ›èªè¨€
        document.getElementById('lang-btn').addEventListener('click', (e) => {
            e.stopPropagation(); // é˜²æ­¢è§¸ç™¼ modal èƒŒæ™¯é»æ“Š
            currentLang = currentLang === 'zh' ? 'en' : 'zh';
            
            // é‡æ–°æ¸²æŸ“ç•¶å‰é¡Œç›® (ä¿ç•™åœ¨ modal ä¸­)
            renderQuizContent(null, null);
        });

        // 2. ç™¼éŸ³åŠŸèƒ½ (TTS) - ä¿®æ­£ï¼šç›´æ¥è®€å–è¢å¹•ä¸Šçš„æŒ‰éˆ•æ–‡å­—
        document.getElementById('tts-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            const qData = questions[currentQuizIndex][currentLang];
            
            // å…ˆè®€é¡Œç›®
            let textToRead = qData.question + ". ";
            
            // ç›´æ¥è®€å–ç›®å‰å·²ç¶“æ¸²æŸ“åœ¨è¢å¹•ä¸Šçš„æŒ‰éˆ• (ç¢ºä¿é †åºä¸€è‡´)
            const renderedBtns = document.querySelectorAll('#quiz-options .option-btn');
            
            renderedBtns.forEach((btn, index) => {
                const optText = btn.innerText;
                if (currentLang === 'zh') {
                    textToRead += `é¸é … ${index + 1}: ${optText}ã€‚ `;
                } else {
                    textToRead += `Option ${index + 1}: ${optText}. `;
                }
            });

            speakText(textToRead);
        });

        function speakText(text) {
            // åœæ­¢ç•¶å‰ç™¼éŸ³
            window.speechSynthesis.cancel();

            const utterance = new SpeechSynthesisUtterance(text);
            
            // è¨­å®šèªè¨€
            if (currentLang === 'zh') {
                utterance.lang = 'zh-HK'; // å»£æ±è©±
            } else {
                utterance.lang = 'en-US'; // è‹±æ–‡
            }

            // èª¿æ•´é€Ÿç‡èˆ‡éŸ³èª¿
            utterance.rate = 0.9;
            utterance.pitch = 1;

            window.speechSynthesis.speak(utterance);
        }

        function startHoldTimer(duration, callback) {
            if (holdTimer) clearTimeout(holdTimer);
            holdTimer = setTimeout(() => {
                holdTimer = null;
                callback();
            }, duration);
        }

        function handleCorrectAnswer() {
            moves--;
            updateStats();
            processMatchesAndRefill(true);
        }

        // --- 6. æ ¸å¿ƒæ¶ˆé™¤èˆ‡æ‰è½é‚è¼¯ (ä¿æŒä¸è®Š) ---
        function checkForMatches(justCheck = false) {
            let hasMatch = false;
            for (let i = 0; i < 64; i++) {
                if (i % width > width - 3) continue;
                let rowOfThree = [i, i + 1, i + 2];
                let decidedType = squares[i].getAttribute('data-type');
                const isBlank = squares[i].getAttribute('data-type') === '';
                if (rowOfThree.every(index => squares[index].getAttribute('data-type') === decidedType && !isBlank)) {
                    hasMatch = true;
                    if (!justCheck) rowOfThree.forEach(index => squares[index].classList.add('matched'));
                }
            }
            for (let i = 0; i < 47; i++) {
                let colOfThree = [i, i + width, i + width * 2];
                let decidedType = squares[i].getAttribute('data-type');
                const isBlank = squares[i].getAttribute('data-type') === '';
                if (colOfThree.every(index => squares[index].getAttribute('data-type') === decidedType && !isBlank)) {
                    hasMatch = true;
                    if (!justCheck) colOfThree.forEach(index => squares[index].classList.add('matched'));
                }
            }
            return hasMatch;
        }

        function processMatchesAndRefill(isPlayerMove) {
            checkForMatches(false); 
            const matchedSquares = document.querySelectorAll('.matched');
            if (matchedSquares.length > 0) {
                const points = matchedSquares.length * 10;
                score += points;
                updateStats();
                if (!isPlayerMove) showCombo();
                matchedSquares.forEach(square => {
                    square.innerText = '';
                    square.setAttribute('data-type', '');
                    square.classList.remove('matched');
                });
                setTimeout(() => {
                    moveDown();
                    setTimeout(() => {
                        if (checkForMatches(true)) {
                            processMatchesAndRefill(false);
                        } else {
                            isProcessing = false;
                            checkGameOver();
                        }
                    }, 250);
                }, 250);
            } else {
                isProcessing = false;
                checkGameOver();
            }
        }

        function moveDown() {
            for (let i = 0; i < width; i++) {
                let columnValues = [];
                for (let j = 0; j < width; j++) {
                    let index = j * width + i;
                    let type = squares[index].getAttribute('data-type');
                    if (type !== '') columnValues.push(type);
                }
                let missingCount = width - columnValues.length;
                for (let k = 0; k < missingCount; k++) {
                    let randomColor = Math.floor(Math.random() * candyColors.length);
                    columnValues.unshift(candyColors[randomColor]);
                }
                for (let j = 0; j < width; j++) {
                    let index = j * width + i;
                    let type = columnValues[j];
                    squares[index].setAttribute('data-type', type);
                    squares[index].innerText = type;
                    squares[index].classList.remove('matched'); 
                }
            }
        }

        function checkRowForThree(silent) {
            for (let i = 0; i < 64; i++) {
                if (i % width > width - 3) continue;
                let rowOfThree = [i, i + 1, i + 2];
                let decidedType = squares[i].getAttribute('data-type');
                const isBlank = squares[i].getAttribute('data-type') === '';
                if (rowOfThree.every(index => squares[index].getAttribute('data-type') === decidedType && !isBlank)) {
                    let randomColor = Math.floor(Math.random() * candyColors.length);
                    squares[i+1].innerText = candyColors[randomColor];
                    squares[i+1].setAttribute('data-type', candyColors[randomColor]);
                }
            }
        }
        function checkColumnForThree(silent) {
            for (let i = 0; i < 47; i++) {
                let colOfThree = [i, i + width, i + width * 2];
                let decidedType = squares[i].getAttribute('data-type');
                const isBlank = squares[i].getAttribute('data-type') === '';
                if (colOfThree.every(index => squares[index].getAttribute('data-type') === decidedType && !isBlank)) {
                    let randomColor = Math.floor(Math.random() * candyColors.length);
                    squares[i+width].innerText = candyColors[randomColor];
                    squares[i+width].setAttribute('data-type', candyColors[randomColor]);
                }
            }
        }

        // --- 7. è¼”åŠ©åŠŸèƒ½ & å ±å‘Šç”Ÿæˆ ---
        function updateStats() {
            scoreDisplay.innerText = score;
            movesDisplay.innerText = moves;
        }

        function checkGameOver() {
            if (moves <= 0) {
                document.getElementById('report-title').innerText = `${playerName} çš„å­¸ç¿’å ±å‘Š`;
                document.getElementById('final-score').innerText = score;
                let accuracy = 0;
                if (totalQuestionsAnswered > 0) {
                    accuracy = Math.round((firstTryCorrectCount / totalQuestionsAnswered) * 100);
                }
                document.getElementById('final-accuracy').innerText = accuracy + "%";
                const reviewList = document.getElementById('review-list');
                reviewList.innerHTML = '';
                if (wrongQuestionsSet.size > 0) {
                    wrongQuestionsSet.forEach(item => {
                        const li = document.createElement('li');
                        li.innerText = item;
                        reviewList.appendChild(li);
                    });
                } else {
                    reviewList.innerHTML = '<div style="text-align: center; color: #4CAF50;">ğŸ‰ å¤ªæ£’äº†ï¼å…¨éƒ¨é¡Œç›®éƒ½ä¸€æ¬¡ç­”å°ï¼</div>';
                }
                document.getElementById('game-over-modal').classList.add('active');
            }
        }

        function showCombo() {
            const combo = document.getElementById('combo-display');
            combo.style.display = 'block';
            combo.style.animation = 'none';
            combo.offsetHeight; 
            combo.style.animation = 'floatUp 1s forwards';
            setTimeout(() => {
                combo.style.display = 'none';
            }, 1000);
        }

        // --- 8. äº‹ä»¶ç¶å®š ---
        document.getElementById('start-btn').addEventListener('click', () => {
            document.getElementById('start-modal').classList.remove('active');
            initGame();
        });

        document.getElementById('restart-btn').addEventListener('click', () => {
            document.getElementById('game-over-modal').classList.remove('active');
            document.getElementById('start-modal').classList.add('active');
        });

    </script>
</body>
</html>
